# HAPTOS Quickstart Guide

Get started with HAPTOS in 5 minutes.

## Installation

```bash
pip install haptos
```

Or from source:
```bash
git clone https://github.com/anthropics/haptos
cd haptos
pip install -e .
```

---

## Your First Haptic Simulation

### 1. Run the Built-in Demo

The fastest way to see HAPTOS in action:

```python
import haptos

# Run 5-second demo with mock hardware
haptos.demo()
```

**Output**:
```
=========================================
  HAPTOS Platform Demo
=========================================

✓ Simulation initialized: simple_hand.xml
✓ Renderer initialized
✓ Driver initialized

Running demo for 5.0 seconds...

  1.0s - Contacts: 150, Rendered: 15, Sent: 15
  ...

Demo Complete!
Simulation: 5000 steps, 150 total contacts
Renderer: 15 inferences, 8.2ms avg
Driver: 6 channels, 90 packets sent, 100% success
```

---

### 2. Basic Simulation (30 Lines)

Complete three-layer example:

```python
import haptos

# Layer 1: Create physics simulation
sim = haptos.Simulation("assets/hand_models/simple_hand.xml")

# Layer 2: Create neural renderer
renderer = haptos.Renderer()

# Layer 3: Create mock hardware driver
driver = haptos.Driver(driver_type="mock")

# Register channel for index fingertip
driver.register(body_part_id=10, port="MOCK")

# Simulation loop (1 second @ 1kHz physics)
for step in range(1000):
    # Step physics (1ms)
    filtered_contacts = sim.step_filtered()

    # Render haptic cues (100Hz - every 10 steps)
    if step % 10 == 0 and filtered_contacts:
        cues = renderer.render(filtered_contacts)

        # Send to hardware
        driver.send(cues)

        # Print status every 100ms
        if step % 100 == 0:
            print(f"Step {step}: {len(filtered_contacts)} contacts")

# Cleanup
driver.disconnect_all()
print("✓ Simulation complete")
```

**Key Points**:
- **1kHz physics** (1ms timestep)
- **100Hz rendering** (every 10 physics steps)
- **Mock driver** (no physical hardware needed)

---

## Core Concepts

### Three-Layer Architecture

```
Layer 1: Simulation @ 1kHz
  Physics → ContactPatch → FilteredContact

Layer 2: Renderer @ 100Hz
  FilteredContact → ML Inference → CueParams

Layer 3: Driver @ 2kHz+
  CueParams → Interpolation → Actuator
```

### Data Flow

```python
# Layer 1: Physics generates contacts
contacts = sim.step_filtered()
# Returns: List[FilteredContact]

# Layer 2: Renderer generates cue parameters
cues = renderer.render(contacts)
# Returns: Dict[body_part_id, CueParams]

# Layer 3: Driver sends to hardware
results = driver.send(cues)
# Returns: Dict[body_part_id, success]
```

---

## Common Tasks

### Multi-Contact Simulation (6 Channels)

```python
import haptos

# Create simulation with high contact limit
sim = haptos.Simulation("model.xml", max_contacts=20)

# Create renderer
renderer = haptos.Renderer()

# Create driver with synchronization
driver = haptos.Driver(enable_sync=True)

# Register 6 channels (5 fingers + palm)
channels = {
    10: "index",
    11: "thumb",
    12: "middle",
    13: "ring",
    14: "pinky",
    15: "palm"
}

for body_part_id, name in channels.items():
    driver.register(body_part_id, f"MOCK_{name.upper()}")

# Run simulation
for step in range(2000):  # 2 seconds
    contacts = sim.step_filtered()

    if step % 10 == 0 and contacts:
        cues = renderer.render(contacts)
        driver.send(cues)

driver.disconnect_all()
```

---

### Custom Perceptual Model

```python
import haptos

# Create default Homunculus
homunculus = haptos.Homunculus()

# Inspect properties
props = homunculus.lookup(10)  # Index fingertip
print(f"Spatial resolution: {props.spatial_res_mm}mm")
print(f"Sensitivity: {props.sensitivity}")

# Save configuration
homunculus.save("my_profile.json")

# Load in simulation
custom = haptos.Homunculus.load("my_profile.json")
sim = haptos.Simulation("model.xml", homunculus=custom)
```

---

### Real Hardware Integration

```python
import haptos

# For real Teensy 4.1 hardware:
driver = haptos.Driver(driver_type="serial")

driver.register(
    body_part_id=10,
    port="/dev/ttyACM0",  # Linux/Mac
    # port="COM3",        # Windows
    config={'baudrate': 115200}
)

# Same simulation loop as before
# ...

driver.disconnect_all()
```

**Requirements**:
- Teensy 4.1 with `firmware/HaptosReceiver.ino` flashed
- USB connection
- Voice coil actuator (optional for testing)

See [firmware/README.md](../firmware/README.md) for hardware setup.

---

## Understanding CueParams

The 5 haptic cues generated by the renderer:

### Continuous Cues (Interpolated)

1. **Texture**
   - `texture_grain_hz`: Frequency of surface texture (50-500 Hz)
   - `texture_amplitude`: Strength of texture (0-1)
   - **Perception**: Surface roughness

2. **Shear**
   - `shear_direction`: Direction of lateral force (x, y)
   - `shear_magnitude`: Strength of shear (0-1)
   - **Perception**: Sliding/pulling forces

3. **Weight**
   - `weight_offset`: Normal force magnitude (0-1)
   - **Perception**: Pressure/grip strength

### Transient Cues (Triggered)

4. **Impact**
   - `impact_amplitude`: Initial strike strength (0-1)
   - `impact_decay_ms`: Decay time (10-500 ms)
   - `impact_frequency_hz`: Strike frequency (80-400 Hz)
   - **Trigger**: `trigger_impulse = True`
   - **Perception**: Initial contact event

5. **Ring**
   - `ring_amplitude`: Resonance strength (0-1)
   - `ring_decay_ms`: Ring-down time (50-1000 ms)
   - **Trigger**: `trigger_impulse = True`
   - **Perception**: Material resonance

---

## Debugging Tips

### Enable Verbose Output

```python
import os
os.environ['HAPTOS_VERBOSE'] = '1'

import haptos
sim = haptos.Simulation("model.xml")
# Will print detailed logs
```

### Check Statistics

```python
# Simulation stats
sim_stats = sim.get_state()
print(f"Time: {sim_stats['time']:.3f}s")
print(f"Contacts: {sim_stats['active_contacts']}")
print(f"Router: {sim_stats['router_stats']}")

# Renderer stats
render_stats = renderer.get_stats()
print(f"Inferences: {render_stats['total_inferences']}")
print(f"Avg time: {render_stats['avg_inference_time_ms']:.2f}ms")

# Driver stats
driver_stats = driver.get_stats()
print(f"Packets sent: {driver_stats['total_sent']}")
print(f"Success rate: {driver_stats['success_rate']:.1%}")
```

### No Contacts Detected?

Common issues:
1. **Hand not in contact**: Check initial pose (`sim.get_qpos()`)
2. **Contacts below threshold**: Lower sensitivity or increase forces
3. **Wrong body part IDs**: Verify geom names in MuJoCo model

```python
# Debug contact detection
for step in range(100):
    contacts = sim.step()  # Raw contacts (before filtering)

    if contacts:
        print(f"Step {step}: {len(contacts)} raw contacts")
        for c in contacts:
            print(f"  Body part {c.body_part_id}: {c.force_normal:.3f}N")
```

---

## Next Steps

1. **Explore Examples**: [examples/](../examples/) - 5 working demos
2. **API Reference**: [api_reference.md](api_reference.md) - Complete API docs
3. **Tutorials**: [tutorials/](tutorials/) - Step-by-step guides
4. **Hardware Setup**: [firmware/README.md](../firmware/README.md) - Teensy integration

---

## Troubleshooting

### "Model file not found"

```python
# Check file exists
import os
print(os.path.exists("assets/hand_models/simple_hand.xml"))

# Or use absolute path
sim = haptos.Simulation("/full/path/to/model.xml")
```

### "Checkpoint not found"

```python
# Check model files
import os
print(os.path.exists("models/checkpoints/nn_v0_best.pt"))
print(os.path.exists("models/checkpoints/nn_v1_best.pt"))

# Or specify paths
renderer = haptos.Renderer(
    model_v0="/full/path/to/nn_v0_best.pt",
    model_v1="/full/path/to/nn_v1_best.pt"
)
```

### "No contacts detected"

1. Check physics is running:
   ```python
   contacts = sim.step()  # Should return list (even if empty)
   ```

2. Check contact forces:
   ```python
   for c in contacts:
       print(f"Force: {c.force_normal}N")
   ```

3. Lower filtering threshold (if needed):
   ```python
   # Create custom Homunculus with lower thresholds
   # (Advanced - see tutorials)
   ```

---

## Getting Help

- **Documentation**: https://haptos.readthedocs.io
- **Examples**: [examples/](../examples/)
- **Issues**: https://github.com/anthropics/haptos/issues
- **Discussions**: https://github.com/anthropics/haptos/discussions

---

**Ready to build?** Check out the [tutorials](tutorials/) for in-depth guides!
